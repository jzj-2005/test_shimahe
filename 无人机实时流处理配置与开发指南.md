# 无人机实时流处理配置与开发指南

**文档类型**：技术实施文档  
**目标读者**：开发部门技术人员  
**项目名称**：石马河四乱检测系统 - 实时流处理模块  
**文档版本**：v1.0  
**编制日期**：2026年2月12日

---

## 文档说明

本文档详细说明无人机实时流处理模块的技术架构、配置要求和开发任务。开发部门需要完成RTSP视频流和MQTT位姿数据的集成配置，确保系统能够实时接收无人机数据并进行四乱检测。

---

## 目录

- [一、实时流处理架构总览](#一实时流处理架构总览)
- [二、RTSP视频流配置](#二rtsp视频流配置)
- [三、MQTT位姿数据配置](#三mqtt位姿数据配置)
- [四、数据同步机制](#四数据同步机制)
- [五、开发任务清单](#五开发任务清单)
- [六、测试验证流程](#六测试验证流程)
- [七、故障排查指南](#七故障排查指南)
- [八、性能优化建议](#八性能优化建议)

---

## 一、实时流处理架构总览

### 1.1 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                      无人机实时流处理系统                         │
└─────────────────────────────────────────────────────────────────┘

    [DJI 无人机/机场]
           │
           ├─────────────────┬─────────────────┐
           │                 │                 │
      ┌────▼────┐      ┌────▼────┐      ┌────▼────┐
      │ 视频流  │      │ 位姿数据 │      │ 控制指令 │
      │ RTSP    │      │ MQTT     │      │ (可选)   │
      └────┬────┘      └────┬────┘      └─────────┘
           │                 │
           │                 │
    ┌──────▼─────────────────▼──────┐
    │      数据接收与缓冲层          │
    │  - RTSP Stream Reader          │
    │  - MQTT Position Subscriber    │
    │  - OCR Fallback (备用)         │
    └──────┬─────────────────────────┘
           │
           ▼
    ┌─────────────────────────────┐
    │    时间戳同步层              │
    │  - Frame Timestamp           │
    │  - Pose Timestamp            │
    │  - Nearest Neighbor Matching │
    │  - Max Time Diff: 200ms      │
    └──────┬──────────────────────┘
           │
           ▼
    ┌─────────────────────────────┐
    │    目标检测层                │
    │  - YOLOv11x Inference        │
    │  - Confidence Filtering      │
    │  - Bounding Box Extraction   │
    └──────┬──────────────────────┘
           │
           ▼
    ┌─────────────────────────────┐
    │    坐标转换层                │
    │  - Pixel → GPS Coordinate    │
    │  - GSD Calculation           │
    │  - 4-Corner Points           │
    └──────┬──────────────────────┘
           │
           ▼
    ┌─────────────────────────────┐
    │    结果输出层                │
    │  - CSV Real-time Append      │
    │  - Screenshot Saving         │
    │  - Real-time Visualization   │
    │  - (Optional) WebSocket Push │
    └─────────────────────────────┘
```

### 1.2 数据流向说明

| 数据流 | 来源 | 传输协议 | 数据内容 | 用途 |
|-------|------|---------|---------|------|
| **视频流** | 无人机图传/机场 | RTSP | H.264/H.265视频编码 | 提供实时画面供YOLO检测 |
| **位姿数据** | 无人机飞控 | MQTT | GPS坐标、高度、姿态角 | 提供检测目标的地理定位依据 |
| **控制指令** | 地面站 | MQTT | 飞行控制命令 | （本项目暂不涉及） |

### 1.3 为什么需要两个数据源？

| 数据源 | 必要性 | 说明 |
|-------|-------|------|
| **RTSP视频流** | ⭐⭐⭐⭐⭐ 必需 | 没有视频画面无法进行目标检测 |
| **MQTT位姿数据** | ⭐⭐⭐⭐⭐ 必需 | 没有GPS和高度数据无法计算目标地理坐标 |
| **OCR备用** | ⭐⭐⭐ 推荐 | MQTT不可用时从视频OSD识别位姿数据（精度略低） |

**核心逻辑**：
- 视频提供"检测到什么目标、在画面哪个位置"
- 位姿数据提供"无人机在哪里、多高、朝哪个方向"
- 结合两者计算出"检测目标在地球表面的GPS坐标"

---

## 二、RTSP视频流配置

### 2.1 什么是RTSP？

**RTSP** (Real Time Streaming Protocol) 是一种实时流传输协议，用于传输音视频流。

**关键特点**：
- 低延迟（通常<1秒）
- 支持实时播放
- 可通过TCP或UDP传输
- 标准URL格式：`rtsp://ip:port/path`

### 2.2 为什么需要RTSP视频流？

| 需求 | 说明 |
|------|------|
| **实时性** | 无人机巡检时需要实时查看检测结果，不能等到视频录制完成后再处理 |
| **无存储** | 避免存储大量视频文件（1小时4K视频约50GB） |
| **即时反馈** | 发现违规目标可立即标记位置，便于后续处置 |
| **标准协议** | RTSP是工业标准，DJI无人机、海康威视等设备都支持 |

### 2.3 RTSP配置参数详解

配置文件：`config/realtime_config.yaml`

```yaml
rtsp:
  # ========== 必填参数 ==========
  
  # RTSP流地址
  # 格式: rtsp://[用户名:密码@]IP地址:端口/路径
  # 示例: rtsp://admin:password@192.168.1.100:8554/live
  url: "rtsp://192.168.1.100:8554/live"
  
  # 说明:
  # - IP地址: 无人机图传设备或机场的IP地址
  # - 端口: 通常为 554 (标准) 或 8554 (自定义)
  # - 路径: 流媒体路径，通常为 /live 或 /stream
  
  # ========== 连接参数 ==========
  
  # 连接超时 (秒)
  connection_timeout: 10
  # 说明: 超过此时间未连接成功则报错
  # 建议: 局域网环境 5-10秒，公网环境 15-30秒
  
  # 读取超时 (秒)
  read_timeout: 5
  # 说明: 读取单帧的最大等待时间
  # 建议: 5-10秒，太短容易误报网络抖动
  
  # 断线重连间隔 (秒)
  reconnect_interval: 5
  # 说明: 连接断开后多久尝试重连
  # 建议: 5-10秒，避免频繁重连消耗资源
  
  # 最大重连次数 (0=无限重连)
  max_reconnect_attempts: 0
  # 说明: 0表示永久重连，正数表示最多重连N次
  # 建议: 实时巡检场景设为 0 (无限重连)
  
  # ========== 性能参数 ==========
  
  # 视频缓冲区大小 (帧数)
  buffer_size: 30
  # 说明: OpenCV接收帧的缓冲队列大小
  # 影响: 
  #   - 太小(5-10): 网络抖动易丢帧，但延迟低
  #   - 太大(100+): 延迟累积，检测结果滞后
  # 建议: 20-50帧 (约1-2秒缓冲)
  
  # 传输协议: "tcp" 或 "udp"
  transport_protocol: "tcp"
  # 说明:
  #   - tcp: 可靠传输，保证数据完整，但延迟略高
  #   - udp: 快速传输，延迟低，但可能丢包
  # 建议: 
  #   - 局域网稳定环境用 tcp
  #   - 网络不稳定或追求低延迟用 udp
```

### 2.4 如何获取RTSP地址？

#### 方案1：DJI 机场 (推荐)

**步骤**：

1. **确认机场型号**
   - DJI Dock (M30系列机场)
   - DJI Dock 2 (M3D/M3TD机场)

2. **登录机场管理界面**
   - 通过浏览器访问机场IP地址（通常是 `http://192.168.1.x`）
   - 输入管理员账号密码登录

3. **查找RTSP配置**
   - 进入"设置" → "视频流"
   - 查看RTSP地址（通常显示为 `rtsp://机场IP:554/live` 或 `rtsp://机场IP:8554/live`）
   - 如果需要认证，记录用户名和密码

4. **测试RTSP流**
   ```bash
   # 使用VLC播放器测试
   vlc rtsp://192.168.1.100:8554/live
   
   # 或使用ffplay测试
   ffplay rtsp://192.168.1.100:8554/live
   ```

**完整配置示例**：
```yaml
rtsp:
  url: "rtsp://admin:Aa123456@192.168.1.100:8554/live"
  connection_timeout: 10
  read_timeout: 5
  transport_protocol: "tcp"
```

#### 方案2：DJI 无人机直连图传

**适用场景**：没有机场，无人机通过遥控器直连

**步骤**：

1. **开启无人机图传**
   - 在DJI Pilot 2 App中进入"设置"
   - 找到"视频流推送"或"RTSP推流"选项
   - 启用RTSP推流

2. **配置推流地址**
   - 目标地址设置为地面站电脑的IP
   - 记录推流端口（默认554或8554）

3. **获取RTSP URL**
   - 格式：`rtsp://遥控器IP:端口/live`
   - 示例：`rtsp://192.168.1.10:8554/stream`

#### 方案3：通过流媒体服务器中转

**适用场景**：无人机 → 中间服务器 → 检测系统

**推荐软件**：
- **EasyDarwin** (国产开源流媒体服务器)
- **ZLMediaKit** (高性能流媒体服务器)
- **MediaMTX** (原rtsp-simple-server)

**优势**：
- 支持多客户端同时观看
- 提供流媒体管理界面
- 支持流录制和回放

**配置流程**：
1. 在服务器上部署流媒体软件
2. 配置无人机推流到服务器：`rtsp://服务器IP:554/live`
3. 检测系统从服务器拉流：`rtsp://服务器IP:554/live`

### 2.5 RTSP获取的数据说明

| 数据类型 | 说明 | 用途 |
|---------|------|------|
| **视频编码流** | H.264或H.265编码的视频数据 | OpenCV解码为图像帧 |
| **分辨率** | 通常为 1920×1080 或 3840×2160 | 影响检测精度 |
| **帧率** | 通常为 25fps 或 30fps | 决定处理频率 |
| **时间戳** | 每帧的接收时间 | 用于与MQTT位姿数据同步 |

**注意事项**：
- RTSP流**不包含GPS和高度数据**，这些数据必须从MQTT获取
- 如果视频画面有OSD（屏幕显示），可作为OCR备用数据源

---

## 三、MQTT位姿数据配置

### 3.1 什么是MQTT？

**MQTT** (Message Queuing Telemetry Transport) 是一种轻量级物联网消息传输协议。

**关键特点**：
- 发布/订阅模式
- 低带宽占用
- 支持QoS质量保证
- 广泛用于物联网设备

**工作原理**：
```
[无人机] --发布消息--> [MQTT Broker] --推送消息--> [检测系统]
                        (消息代理服务器)
```

### 3.2 为什么需要MQTT位姿数据？

| 需求 | 说明 |
|------|------|
| **地理定位** | 必须知道无人机的GPS坐标才能计算目标GPS坐标 |
| **高度信息** | 需要飞行高度计算地面分辨率GSD，进而转换像素→米 |
| **姿态信息** | 需要俯仰角、偏航角修正坐标投影（当前版本假设水平飞行） |
| **实时性** | MQTT推送模式，延迟<100ms，比轮询更高效 |
| **标准协议** | DJI Cloud API基于MQTT，工业标准，稳定可靠 |

### 3.3 M3TD/M4TD专用配置（重要更新）⭐

**适用设备**：DJI M3TD / M4TD 无人机

#### 关键变更：使用OSD主题

M3TD/M4TD无人机支持专用的OSD（On-Screen Display）主题，提供更全面的飞行遥测数据：

**主题对比**：

| 主题类型 | 主题格式 | 数据内容 | 推送频率 | 推荐度 |
|---------|---------|---------|---------|--------|
| **OSD主题** | `thing/product/{sn}/osd` | GPS、高度、姿态、速度、电池等完整数据 | ~10Hz | ⭐⭐⭐⭐⭐ 强烈推荐 |
| State主题 | `thing/product/{sn}/state` | 通用状态数据 | 事件触发 | 不推荐M3TD/M4TD使用 |

**重要提示**：
- ✅ M3TD/M4TD **必须使用** `/osd` 主题
- ❌ **不要使用** `/state` 主题（数据不完整）
- ✅ OSD主题包含所有检测系统需要的数据
- ✅ 推送频率高，适合实时处理

#### M3TD/M4TD配置示例

配置文件：`config/realtime_config.yaml`

```yaml
mqtt:
  # ========== 必填参数 ==========
  
  # MQTT Broker地址（M3TD/M4TD使用DJI官方服务器）
  broker: "mqtt-cn.dji.com"  # 中国大陆用户
  # broker: "mqtt-us.dji.com"  # 其他地区用户
  
  # MQTT端口
  port: 1883  # 标准端口（生产环境建议使用8883加密端口）
  
  # ========== 认证参数（必须从DJI平台获取）==========
  
  # 用户名 - DJI App Key
  # 获取步骤：
  # 1. 访问 https://developer.dji.com/
  # 2. 注册开发者账号
  # 3. 创建"云服务应用"类型应用
  # 4. 在"应用详情"中复制 App Key
  username: "[请填写DJI App Key]"  # ⚠️ 必须修改
  
  # 密码 - DJI App Secret
  # 在创建应用后从"应用详情"中复制
  password: "[请填写DJI App Secret]"  # ⚠️ 必须修改
  
  # 客户端ID（自定义唯一标识）
  # 格式建议: {项目}_{环境}_{编号}
  client_id: "stone_river_inspection_realtime_001"
  
  # ========== 订阅主题（M3TD/M4TD使用OSD主题）==========
  
  topics:
    # ⭐ M3TD/M4TD OSD主题（核心数据）
    # 格式: thing/product/{M3TD/M4TD设备SN}/osd
    # 注意：必须以 /osd 结尾，不是 /state
    # 示例: "thing/product/1581F5BKD233200012AB/osd"
    aircraft_state: "thing/product/[请填写M3TD/M4TD设备SN]/osd"  # ⚠️ 必须修改
    
    # 可选: 设备在线状态
    # device_online: "thing/product/[设备SN]/online"
    
    # 可选: 设备事件
    # device_events: "thing/product/[设备SN]/events"
  
  # ========== 连接参数 ==========
  
  # QoS 质量等级
  # 0: 最多一次 (At most once) - 不保证送达
  # 1: 至少一次 (At least once) - 保证送达，可能重复
  # 2: 只有一次 (Exactly once) - 保证送达且不重复
  qos: 1
  # 建议: 使用 1 ，兼顾可靠性和性能
  
  # 心跳间隔 (秒)
  keep_alive: 60
  # 说明: 客户端向服务器发送心跳的间隔，用于保持连接
  
  # 连接超时 (秒)
  connection_timeout: 10
  
  # 断线重连间隔 (秒)
  reconnect_interval: 5
  
  # 位姿数据缓冲区大小
  pose_buffer_size: 100
  # 说明: 保留最近N条位姿数据，用于与视频帧匹配
  # 影响: 太小(10)可能导致匹配失败，太大(1000)占用内存
  # 建议: 100 (约保留最近10秒数据，按10Hz推送频率)
```

### 3.4 如何获取MQTT配置参数？

#### 步骤1：注册DJI开发者账号

1. **访问DJI开发者平台**
   - URL: https://developer.dji.com/
   - 点击"注册"

2. **完成账号注册**
   - 填写邮箱、密码
   - 验证邮箱
   - 完善个人/企业信息

3. **登录开发者平台**

#### 步骤2：创建应用获取App Key和App Secret

1. **进入控制台**
   - 登录后点击"控制台"

2. **创建新应用**
   - 点击"创建应用"
   - 填写以下信息：
     - **应用名称**：例如"石马河四乱检测系统"
     - **应用类型**：选择"云服务应用"
     - **应用描述**：简要说明用途，例如"水利巡检目标检测"
   - 点击"确认创建"

3. **获取认证信息**
   - 创建成功后，进入"应用详情"
   - 记录以下信息：
     - ✅ **App ID** (应用标识)
     - ✅ **App Key** (MQTT用户名)
     - ✅ **App Secret** (MQTT密码)
     - ✅ **App License** (应用许可证)

**示例**：
```
App ID: com.example.inspection
App Key: 1234567890abcdef1234567890abcdef
App Secret: abcdefghijklmnopqrstuvwxyz123456
```

#### 步骤3：绑定设备并获取SN码

1. **进入设备管理**
   - 在应用详情页面，找到"设备管理"选项卡
   - 点击"添加设备"

2. **添加设备**
   - **方式1**：扫描设备二维码
   - **方式2**：手动输入设备SN码

3. **获取设备SN码的方法**

   **方法A：从DJI Pilot 2查看**
   - 打开DJI Pilot 2 App
   - 连接无人机或机场
   - 进入"设置" → "关于" → "设备信息"
   - 查看并复制设备序列号（SN）
   
   **方法B：从机场设备查看**
   - 登录机场管理界面
   - 进入"系统信息"或"设备信息"
   - 查看设备序列号
   
   **方法C：从设备外壳查看**
   - 查看机场或无人机外壳上的标签
   - 找到标注为"SN"或"序列号"的字段

4. **记录设备SN码**
   - 示例：`1581F5BKD233200012AB`
   - 注意：SN码通常为15-20位字母数字组合

#### 步骤4：配置MQTT连接参数

将上述信息填入配置文件：

```yaml
mqtt:
  broker: "mqtt-cn.dji.com"
  port: 1883
  
  # 填入你的App Key
  username: "1234567890abcdef1234567890abcdef"
  
  # 填入你的App Secret
  password: "abcdefghijklmnopqrstuvwxyz123456"
  
  # 填入你的App ID或自定义客户端ID
  client_id: "stone_river_inspection_v1"
  
  topics:
    # 替换 {your_device_sn} 为实际设备SN
    aircraft_state: "thing/product/1581F5BKD233200012AB/state"
    device_online: "thing/product/1581F5BKD233200012AB/online"
  
  qos: 1
  keep_alive: 60
  connection_timeout: 10
  reconnect_interval: 5
  pose_buffer_size: 100
```

### 3.5 MQTT消息数据格式

#### M3TD/M4TD OSD主题数据格式（推荐）⭐

**主题**：`thing/product/{gateway_sn}/osd`  
**消息频率**：约10Hz (每秒10次)  
**数据特点**：包含完整飞行遥测数据

**OSD消息格式** (JSON)：

```json
{
  "tid": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
  "bid": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
  "timestamp": 1707730815123,                    // 毫秒时间戳
  "data": {
    # ========== GPS坐标（必需）==========
    "latitude": 22.779954,                       // 纬度 (度, WGS84，来自DJI飞控)
    "longitude": 114.100891,                     // 经度 (度, WGS84，来自DJI飞控)
    // 注意：系统会自动将检测目标坐标转换为CGCS2000（国家标准）
    
    // ========== 高度信息（必需）==========
    "altitude": 139.231,                         // 海拔高度 (米)
    // 或: "altitude_above_sea_level": 139.231,
    "height": 120.5,                             // 相对起飞点高度 (米)
    
    // ========== 姿态角（必需）==========
    "attitude_head": 45.2,                       // 偏航角/航向 (度, 0-360)
    "attitude_pitch": -88.5,                     // 俯仰角 (度, -90向下, 0水平)
    "attitude_roll": 0.1,                        // 横滚角 (度, -180到180)
    
    // 或使用另一种字段名（取决于实际推送格式）:
    // "yaw": 45.2,
    // "pitch": -88.5,
    // "roll": 0.1,
    
    // ========== 其他数据（可选）==========
    "horizontal_speed": 5.2,                     // 水平速度 (m/s)
    "vertical_speed": 0.0,                       // 垂直速度 (m/s)
    "battery_percent": 85,                       // 电池电量 (%)
    "gimbal_pitch": -90.0                        // 云台俯仰角 (度)
  }
}
```

**重要说明**：
1. 字段名称可能因固件版本略有差异
2. 系统代码已支持多种可能的字段名称（自动兼容）
3. 首次配置建议使用测试脚本查看实际数据格式

---

#### 通用State主题数据格式（备用）

**主题**：`thing/product/{gateway_sn}/state`  
**消息频率**：事件触发  
**注意**：不推荐M3TD/M4TD使用

**State消息格式** (JSON)：

```json
{
  "tid": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
  "bid": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
  "timestamp": 1707730815123,
  "method": "state",
  "data": {
    "latitude": 22.779954,           // 纬度 (度)
    "longitude": 114.100891,         // 经度 (度)
    "altitude": 139.231,             // 海拔高度 (米)
    "height": 120.5,                 // 相对起飞点高度 (米)
    "attitude": {
      "yaw": 45.2,                   // 偏航角 (度, 0-360)
      "pitch": -88.5,                // 俯仰角 (度, -90向下, 0水平, 90向上)
      "roll": 0.1                    // 横滚角 (度, -180到180)
    },
    "speed": {
      "horizontal": 5.2,             // 水平速度 (m/s)
      "vertical": 0.0                // 垂直速度 (m/s, 正值上升)
    },
    "battery": {
      "capacity": 85,                // 电池电量 (%)
      "voltage": 25.2                // 电池电压 (V)
    },
    "gimbal": {
      "pitch": -90.0,                // 云台俯仰角 (度)
      "yaw": 0.0,                    // 云台偏航角 (度)
      "roll": 0.0                    // 云台横滚角 (度)
    }
  }
}
```

#### 系统需要的核心字段

| 字段路径 | 数据类型 | 单位 | 说明 | 必需性 |
|---------|---------|-----|------|--------|
| `data.latitude` | Float | 度 | WGS84纬度坐标（DJI飞控原始数据） | ⭐⭐⭐⭐⭐ 必需 |
| `data.longitude` | Float | 度 | WGS84经度坐标（DJI飞控原始数据） | ⭐⭐⭐⭐⭐ 必需 |
| `data.altitude` | Float | 米 | 海拔高度（用于GSD计算） | ⭐⭐⭐⭐⭐ 必需 |
| `data.height` | Float | 米 | 相对高度（可替代altitude） | ⭐⭐⭐⭐ 推荐 |
| `data.attitude.yaw` | Float | 度 | 偏航角（飞行方向） | ⭐⭐⭐ 推荐 |
| `data.attitude.pitch` | Float | 度 | 俯仰角（相机朝向） | ⭐⭐⭐ 推荐 |
| `data.attitude.roll` | Float | 度 | 横滚角（机身倾斜） | ⭐⭐ 可选 |
| `timestamp` | Long | 毫秒 | 消息时间戳 | ⭐⭐⭐⭐ 推荐 |

**注意**：检测目标坐标会自动从WGS84转换为CGCS2000（中国国家标准）

#### 数据字段映射代码

位置：`src/input/mqtt_client.py`

```python
def _handle_aircraft_state(self, payload):
    """处理无人机状态消息"""
    try:
        data = payload.get('data', {})
        
        # 提取核心位姿数据
        pose = {
            'timestamp': payload.get('timestamp', time.time() * 1000),
            'latitude': float(data.get('latitude', 0)),
            'longitude': float(data.get('longitude', 0)),
            'altitude': float(data.get('altitude', 0)),
            'height': float(data.get('height', 0)),
            'yaw': float(data.get('attitude', {}).get('yaw', 0)),
            'pitch': float(data.get('attitude', {}).get('pitch', -90)),
            'roll': float(data.get('attitude', {}).get('roll', 0))
        }
        
        # 添加到位姿缓冲区
        self._pose_buffer.append(pose)
        
        # 限制缓冲区大小
        if len(self._pose_buffer) > self.config['pose_buffer_size']:
            self._pose_buffer.pop(0)
        
        logging.debug(f"接收位姿数据: GPS({pose['latitude']:.6f}, {pose['longitude']:.6f}), 高度{pose['altitude']:.1f}m")
        
    except Exception as e:
        logging.error(f"解析位姿数据失败: {e}")
```

**⚠️ 重要提示**：
如果DJI实际推送的消息格式与上述不同，需要修改 `_handle_aircraft_state` 方法中的字段路径。

### 3.6 验证MQTT数据接收

#### 方法1：使用Python测试脚本

创建测试文件 `test_mqtt_realtime.py`：

```python
"""MQTT连接测试脚本"""
import sys
import time
import yaml

sys.path.insert(0, './')

from src.input.mqtt_client import DJIMQTTClient

# 加载配置
with open('config/realtime_config.yaml', 'r', encoding='utf-8') as f:
    config = yaml.safe_load(f)

mqtt_config = config['mqtt']

print("=" * 60)
print("MQTT连接测试")
print("=" * 60)
print(f"Broker: {mqtt_config['broker']}:{mqtt_config['port']}")
print(f"Client ID: {mqtt_config['client_id']}")
print(f"订阅主题: {mqtt_config['topics']['aircraft_state']}")
print("=" * 60)

# 创建MQTT客户端
client = DJIMQTTClient(mqtt_config)

# 尝试连接
print("\n[1/3] 正在连接MQTT服务器...")
if client.connect():
    print("✅ MQTT连接成功!")
else:
    print("❌ MQTT连接失败!")
    sys.exit(1)

# 等待接收数据
print("\n[2/3] 等待接收位姿数据... (最多等待15秒)")
for i in range(15):
    time.sleep(1)
    pose = client.get_latest_pose()
    if pose:
        print(f"✅ 成功接收位姿数据! (第{i+1}秒)")
        break
    print(f"   等待中... {i+1}/15秒", end='\r')

# 显示数据
print("\n[3/3] 位姿数据内容:")
if pose:
    print("-" * 60)
    print(f"  时间戳: {pose.get('timestamp', 0)}")
    print(f"  GPS纬度: {pose.get('latitude', 0):.6f}°")
    print(f"  GPS经度: {pose.get('longitude', 0):.6f}°")
    print(f"  海拔高度: {pose.get('altitude', 0):.2f} 米")
    print(f"  相对高度: {pose.get('height', 0):.2f} 米")
    print(f"  偏航角: {pose.get('yaw', 0):.1f}°")
    print(f"  俯仰角: {pose.get('pitch', 0):.1f}°")
    print(f"  横滚角: {pose.get('roll', 0):.1f}°")
    print("-" * 60)
    print("\n✅ 测试通过! MQTT位姿数据接收正常")
else:
    print("❌ 未接收到位姿数据")
    print("\n可能的原因:")
    print("  1. 设备SN码配置错误")
    print("  2. 设备未在线（机场未通电或无人机未开机）")
    print("  3. 主题订阅错误")
    print("  4. 网络连接问题")

# 断开连接
client.disconnect()
print("\n✅ MQTT连接已关闭")
```

**运行测试**：
```bash
python test_mqtt_realtime.py
```

**预期输出**：
```
============================================================
MQTT连接测试
============================================================
Broker: mqtt-cn.dji.com:1883
Client ID: stone_river_inspection_v1
订阅主题: thing/product/1581F5BKD233200012AB/state
============================================================

[1/3] 正在连接MQTT服务器...
✅ MQTT连接成功!

[2/3] 等待接收位姿数据... (最多等待15秒)
✅ 成功接收位姿数据! (第3秒)

[3/3] 位姿数据内容:
------------------------------------------------------------
  时间戳: 1707730815123
  GPS纬度: 22.779954°
  GPS经度: 114.100891°
  海拔高度: 139.23 米
  相对高度: 120.50 米
  偏航角: 45.2°
  俯仰角: -88.5°
  横滚角: 0.1°
------------------------------------------------------------

✅ 测试通过! MQTT位姿数据接收正常

✅ MQTT连接已关闭
```

#### 方法2：使用MQTT客户端工具

**推荐工具**：
- **MQTTX** (https://mqttx.app/) - 跨平台，界面友好
- **MQTT Explorer** (https://mqtt-explorer.com/) - 可视化消息树
- **Mosquitto Client** - 命令行工具

**使用MQTTX测试**：

1. **下载安装MQTTX**
   - 访问 https://mqttx.app/zh/downloads
   - 下载对应平台版本

2. **创建新连接**
   - 点击"新建连接"
   - 填写以下信息：
     - Name: DJI Drone Test
     - Host: `mqtt-cn.dji.com`
     - Port: `1883`
     - Username: 你的App Key
     - Password: 你的App Secret
     - Client ID: test_client_001

3. **连接并订阅主题**
   - 点击"连接"
   - 在订阅栏输入主题：`thing/product/你的设备SN/state`
   - 点击"订阅"

4. **查看消息**
   - 如果配置正确，会看到每秒约10条JSON消息
   - 展开消息查看GPS和高度数据

---

## 四、数据同步机制

### 4.1 为什么需要数据同步？

**问题背景**：
- RTSP视频流：每秒25-30帧，连续到达
- MQTT位姿数据：每秒约10条消息，独立到达
- 两个数据源各自独立，到达时间不同步

**同步目标**：
- 对每一帧视频，找到时间最接近的位姿数据
- 确保检测目标的GPS坐标基于正确的无人机位置

### 4.2 同步策略

#### 策略1：最近邻匹配 (Nearest Neighbor)

**算法逻辑**：
```python
def find_closest_pose(frame_timestamp, pose_buffer, max_time_diff=200):
    """
    为视频帧找到最接近的位姿数据
    
    参数:
        frame_timestamp: 视频帧时间戳 (毫秒)
        pose_buffer: 位姿数据缓冲区 (列表)
        max_time_diff: 最大允许时间差 (毫秒)
    
    返回:
        最近的位姿数据，如果超出max_time_diff则返回None
    """
    if not pose_buffer:
        return None
    
    min_diff = float('inf')
    closest_pose = None
    
    for pose in pose_buffer:
        time_diff = abs(frame_timestamp - pose['timestamp'])
        if time_diff < min_diff:
            min_diff = time_diff
            closest_pose = pose
    
    # 检查时间差是否在允许范围内
    if min_diff <= max_time_diff:
        return closest_pose
    else:
        return None
```

**优点**：
- 简单高效
- 适合实时处理
- 时间同步精度<200ms

**缺点**：
- 不考虑运动趋势
- 如果位姿数据推送延迟，可能匹配失败

#### 策略2：线性插值 (Linear Interpolation)

**算法逻辑**：
```python
def interpolate_pose(frame_timestamp, pose_buffer):
    """
    通过线性插值计算视频帧对应的位姿
    
    参数:
        frame_timestamp: 视频帧时间戳 (毫秒)
        pose_buffer: 位姿数据缓冲区 (已按时间排序)
    
    返回:
        插值后的位姿数据
    """
    if len(pose_buffer) < 2:
        return None
    
    # 找到时间戳前后的两个位姿点
    before_pose = None
    after_pose = None
    
    for i in range(len(pose_buffer) - 1):
        if pose_buffer[i]['timestamp'] <= frame_timestamp <= pose_buffer[i+1]['timestamp']:
            before_pose = pose_buffer[i]
            after_pose = pose_buffer[i+1]
            break
    
    if not before_pose or not after_pose:
        # 如果找不到，降级为最近邻
        return find_closest_pose(frame_timestamp, pose_buffer)
    
    # 计算插值系数
    t1 = before_pose['timestamp']
    t2 = after_pose['timestamp']
    t = frame_timestamp
    alpha = (t - t1) / (t2 - t1)  # 0到1之间
    
    # 线性插值
    interpolated_pose = {
        'timestamp': frame_timestamp,
        'latitude': before_pose['latitude'] + alpha * (after_pose['latitude'] - before_pose['latitude']),
        'longitude': before_pose['longitude'] + alpha * (after_pose['longitude'] - before_pose['longitude']),
        'altitude': before_pose['altitude'] + alpha * (after_pose['altitude'] - before_pose['altitude']),
        'yaw': interpolate_angle(before_pose['yaw'], after_pose['yaw'], alpha),
        'pitch': before_pose['pitch'] + alpha * (after_pose['pitch'] - before_pose['pitch']),
        'roll': before_pose['roll'] + alpha * (after_pose['roll'] - before_pose['roll'])
    }
    
    return interpolated_pose
```

**优点**：
- 更高的同步精度
- 平滑运动轨迹
- 适合高速飞行场景

**缺点**：
- 计算复杂度略高
- 需要至少2个位姿点

### 4.3 配置同步参数

配置文件：`config/realtime_config.yaml`

```yaml
data_sync:
  # 帧与位姿数据的最大时间差 (毫秒)
  max_time_diff: 200
  # 说明:
  #   - MQTT推送频率10Hz，理论最大延迟100ms
  #   - 考虑网络延迟，设为200ms
  #   - 如果视频帧在200ms内找不到匹配的位姿数据，跳过该帧
  # 影响:
  #   - 太小(50ms): 匹配失败率高，丢弃很多帧
  #   - 太大(1000ms): 坐标精度下降，快速飞行时误差大
  # 建议: 100-300ms
  
  # 同步策略: "nearest" (最近邻) 或 "interpolate" (插值)
  sync_strategy: "nearest"
  # 说明:
  #   - nearest: 简单快速，适合大多数场景
  #   - interpolate: 精度更高，适合高速飞行或要求极高精度的场景
  # 建议: 默认使用 "nearest"
  
  # 如果找不到匹配的位姿数据，是否跳过该帧
  skip_unmatched_frames: true
  # 说明:
  #   - true: 跳过无法匹配的帧，保证输出数据质量
  #   - false: 使用最近的位姿数据（可能时间差较大），检测结果可能不准
  # 建议: true
  
  # 位姿数据缓存时间 (秒)
  pose_cache_duration: 10
  # 说明: 保留最近N秒的位姿数据用于匹配
  # 影响: 太小(1秒)可能导致匹配失败，太大(60秒)占用内存
  # 建议: 5-15秒
```

### 4.4 同步流程图

```
┌─────────────┐         ┌─────────────┐
│  RTSP线程   │         │  MQTT线程   │
│  接收视频帧 │         │  接收位姿   │
└──────┬──────┘         └──────┬──────┘
       │                       │
       │ Frame                 │ Pose
       │ (t=1000ms)            │ (t=995ms)
       ▼                       ▼
  ┌────────────────────────────────┐
  │     数据同步队列               │
  │  Frame Buffer + Pose Buffer    │
  └──────┬─────────────────────────┘
         │
         │ 主处理循环
         ▼
  ┌─────────────────────┐
  │ 1. 从Frame Buffer    │
  │    取出一帧          │
  │    timestamp=1000ms  │
  └──────┬──────────────┘
         │
         ▼
  ┌────────────────────────────┐
  │ 2. 在Pose Buffer中查找     │
  │    时间最接近的位姿数据     │
  │    候选:                   │
  │    - Pose1: t=995ms  ✓     │
  │    - Pose2: t=1005ms       │
  │    选择: Pose1 (差5ms)     │
  └──────┬─────────────────────┘
         │
         ▼
  ┌─────────────────────┐
  │ 3. 检查时间差        │
  │    5ms < 200ms ✓     │
  │    匹配成功          │
  └──────┬──────────────┘
         │
         ▼
  ┌─────────────────────┐
  │ 4. 组合数据          │
  │    Frame + Pose      │
  │    送入检测模块      │
  └──────┬──────────────┘
         │
         ▼
     YOLO检测
```

---

## 五、开发任务清单

### 5.1 任务优先级说明

| 优先级 | 说明 |
|-------|------|
| P0 - 紧急 | 阻塞系统运行，必须立即完成 |
| P1 - 高 | 核心功能，第一批开发 |
| P2 - 中 | 重要功能，第二批开发 |
| P3 - 低 | 优化项，有时间再做 |

### 5.2 详细任务列表

#### 任务组1：环境配置与准备 (P0)

| 任务ID | 任务描述 | 负责人 | 预计工时 | 交付物 |
|-------|---------|-------|---------|--------|
| T1.1 | 注册DJI开发者账号并创建应用 | 项目负责人 | 0.5天 | App Key、App Secret、App ID |
| T1.2 | 获取无人机/机场设备SN码 | 硬件工程师 | 0.5天 | 设备SN列表文档 |
| T1.3 | 在DJI平台绑定设备到应用 | 项目负责人 | 0.5天 | 绑定成功截图 |
| T1.4 | 配置无人机/机场的RTSP推流 | 硬件工程师 | 1天 | RTSP地址、测试视频流 |
| T1.5 | 测试网络连接（MQTT、RTSP） | 网络工程师 | 0.5天 | 网络连通性测试报告 |

**验收标准**：
- ✅ 能够在MQTTX工具中连接DJI MQTT服务器
- ✅ 能够在VLC中播放RTSP视频流
- ✅ 网络延迟 < 100ms (局域网) 或 < 500ms (公网)

#### 任务组2：配置文件修改 (P1)

| 任务ID | 任务描述 | 负责人 | 预计工时 | 交付物 |
|-------|---------|-------|---------|--------|
| T2.1 | 编辑 `config/realtime_config.yaml` - RTSP部分 | 后端开发 | 0.5天 | 完整配置文件 |
| T2.2 | 编辑 `config/realtime_config.yaml` - MQTT部分 | 后端开发 | 0.5天 | 完整配置文件 |
| T2.3 | 编辑 `config/camera_params.yaml` - 相机参数 | 算法工程师 | 1天 | 相机参数配置文件 |
| T2.4 | 编辑 `config/yolo_config.yaml` - 检测参数 | 算法工程师 | 0.5天 | 检测参数配置文件 |

**具体任务**：

**T2.1 - RTSP配置**
```yaml
# 需要修改的参数:
rtsp:
  url: "rtsp://[实际IP]:[实际端口]/[实际路径]"  # 替换为实际RTSP地址
  connection_timeout: 10                        # 根据网络环境调整
  transport_protocol: "tcp"                     # 或 "udp"，根据实际测试选择
```

**T2.2 - MQTT配置**
```yaml
# 需要修改的参数:
mqtt:
  broker: "mqtt-cn.dji.com"                     # 或 "mqtt-us.dji.com"
  port: 1883                                    # 或 8883 (SSL)
  username: "[从DJI平台复制App Key]"
  password: "[从DJI平台复制App Secret]"
  client_id: "[自定义客户端ID]"
  topics:
    aircraft_state: "thing/product/[设备SN]/state"  # 替换[设备SN]
```

**T2.3 - 相机参数配置**
```yaml
# 需要修改的参数（根据实际无人机相机）:
camera:
  model: "M4TD"                                 # 或实际相机型号
  resolution:
    width: 5472                                 # 实际分辨率宽度
    height: 3648                                # 实际分辨率高度
  sensor_size:
    width: 13.2                                 # 传感器尺寸(mm)
    height: 8.8
  focal_length: 8.8                             # 焦距(mm)
```

**验收标准**：
- ✅ 所有占位符已替换为实际值
- ✅ 配置文件YAML格式正确，无语法错误
- ✅ 提交配置文件变更记录

#### 任务组3：MQTT数据接收测试 (P1)

| 任务ID | 任务描述 | 负责人 | 预计工时 | 交付物 |
|-------|---------|-------|---------|--------|
| T3.1 | 运行MQTT连接测试脚本 | 后端开发 | 0.5天 | 测试日志和截图 |
| T3.2 | 验证MQTT消息格式是否符合预期 | 后端开发 | 0.5天 | 消息格式对比文档 |
| T3.3 | 如消息格式不同，修改解析代码 | 后端开发 | 1天 | 修改后的 `mqtt_client.py` |
| T3.4 | 测试位姿数据提取准确性 | 后端开发 | 0.5天 | 位姿数据验证报告 |

**具体任务**：

**T3.1 - 运行测试脚本**
```bash
# 创建测试脚本 test_mqtt_realtime.py（见前文）
python test_mqtt_realtime.py

# 预期输出: 
# ✅ MQTT连接成功
# ✅ 成功接收位姿数据
# 显示GPS、高度等信息
```

**T3.2 - 验证消息格式**
- 使用MQTTX工具查看原始MQTT消息
- 对比实际消息与文档中的示例格式
- 记录差异点（如字段名不同、嵌套层级不同）

**T3.3 - 修改解析代码（如果需要）**

如果DJI实际消息格式为：
```json
{
  "data": {
    "location": {
      "lat": 22.779954,
      "lng": 114.100891,
      "alt": 139.231
    }
  }
}
```

则需要修改 `src/input/mqtt_client.py`：
```python
# 原代码:
latitude = float(data.get('latitude', 0))
longitude = float(data.get('longitude', 0))
altitude = float(data.get('altitude', 0))

# 修改为:
location = data.get('location', {})
latitude = float(location.get('lat', 0))
longitude = float(location.get('lng', 0))
altitude = float(location.get('alt', 0))
```

**验收标准**：
- ✅ 测试脚本成功连接MQTT服务器
- ✅ 能够正确解析出GPS坐标、高度、姿态角
- ✅ 位姿数据推送频率稳定（约10Hz）

#### 任务组4：RTSP视频流测试 (P1)

| 任务ID | 任务描述 | 负责人 | 预计工时 | 交付物 |
|-------|---------|-------|---------|--------|
| T4.1 | 使用VLC/ffplay测试RTSP流播放 | 硬件工程师 | 0.5天 | 播放测试截图 |
| T4.2 | 运行RTSP连接测试脚本 | 后端开发 | 0.5天 | 测试日志 |
| T4.3 | 测试RTSP流稳定性（持续30分钟） | 后端开发 | 1天 | 稳定性测试报告 |
| T4.4 | 测试RTSP断线重连机制 | 后端开发 | 0.5天 | 重连测试报告 |

**具体任务**：

**T4.1 - 播放测试**
```bash
# 使用VLC播放器
vlc rtsp://192.168.1.100:8554/live

# 或使用ffplay
ffplay -rtsp_transport tcp rtsp://192.168.1.100:8554/live

# 检查:
# - 是否能正常播放
# - 延迟是否在1秒内
# - 是否有卡顿、花屏
```

**T4.3 - 稳定性测试**
- 启动RTSP流接收程序
- 持续运行30分钟
- 记录：
  - 帧率是否稳定
  - 是否有断流情况
  - 内存占用是否持续增长

**验收标准**：
- ✅ RTSP流能够正常播放
- ✅ 延迟 < 1秒
- ✅ 30分钟测试期间断流次数 < 3次
- ✅ 断流后能够自动重连

#### 任务组5：完整流程集成测试 (P1)

| 任务ID | 任务描述 | 负责人 | 预计工时 | 交付物 |
|-------|---------|-------|---------|--------|
| T5.1 | 启动完整实时处理流程 | 后端开发 | 0.5天 | 启动日志 |
| T5.2 | 验证YOLO检测功能 | 算法工程师 | 1天 | 检测结果截图 |
| T5.3 | 验证坐标转换功能 | 算法工程师 | 1天 | GPS坐标验证报告 |
| T5.4 | 验证CSV输出功能 | 后端开发 | 0.5天 | 示例CSV文件 |
| T5.5 | 性能测试（FPS、延迟、资源占用） | 后端开发 | 1天 | 性能测试报告 |

**具体任务**：

**T5.1 - 启动完整流程**
```bash
# 激活环境
conda activate drone_inspection

# 启动实时处理
python run_realtime.py

# 预期输出:
# [INFO] 连接RTSP流: rtsp://...
# [INFO] 连接MQTT: mqtt-cn.dji.com
# [INFO] RTSP连接成功
# [INFO] MQTT连接成功
# [INFO] 开始实时处理...
```

**T5.2 - 检测功能验证**
- 系统运行期间，让无人机飞越检测目标（如河道、建筑）
- 观察屏幕实时显示是否绘制检测框
- 检查检测框位置是否准确
- 检查类别标签和置信度是否显示

**T5.3 - 坐标转换验证**
- 随机抽取10个检测结果
- 将GPS坐标在地图上标注（使用quick_visualize工具）
- 人工对比检测目标是否在正确位置
- 记录坐标偏差（目标值 < 5米）

**T5.5 - 性能测试**

测试指标：
| 指标 | 测试方法 | 目标值 |
|------|---------|--------|
| 处理帧率 | 统计每秒处理帧数 | > 20 FPS |
| 端到端延迟 | 视频接收到检测完成的时间 | < 500ms |
| GPU显存占用 | nvidia-smi查看 | < 5GB |
| CPU占用率 | 任务管理器查看 | < 60% |
| 内存占用 | 任务管理器查看 | < 8GB |

**验收标准**：
- ✅ 系统能够正常启动并运行
- ✅ YOLO检测准确率 > 80%
- ✅ GPS坐标误差 < 5米
- ✅ CSV文件格式正确，字段完整
- ✅ 性能指标达标

#### 任务组6：异常处理与容错 (P2)

| 任务ID | 任务描述 | 负责人 | 预计工时 | 交付物 |
|-------|---------|-------|---------|--------|
| T6.1 | 测试MQTT断线重连 | 后端开发 | 0.5天 | 重连测试报告 |
| T6.2 | 测试RTSP断流重连 | 后端开发 | 0.5天 | 重连测试报告 |
| T6.3 | 测试位姿数据长时间无更新的处理 | 后端开发 | 0.5天 | 异常处理测试报告 |
| T6.4 | 测试GPU显存不足的降级处理 | 后端开发 | 0.5天 | 降级处理测试报告 |

**验收标准**：
- ✅ 网络断开后能够自动重连
- ✅ 重连成功后继续正常工作
- ✅ 异常情况下不崩溃，记录日志

#### 任务组7：文档与交付 (P2)

| 任务ID | 任务描述 | 负责人 | 预计工时 | 交付物 |
|-------|---------|-------|---------|--------|
| T7.1 | 编写配置参数说明文档 | 后端开发 | 0.5天 | 配置说明文档 |
| T7.2 | 编写操作手册 | 项目负责人 | 1天 | 操作手册 |
| T7.3 | 编写故障排查手册 | 后端开发 | 1天 | 故障排查手册 |
| T7.4 | 录制操作演示视频 | 项目负责人 | 0.5天 | 操作演示视频 |

---

## 六、测试验证流程

### 6.1 单元测试

#### 测试1：MQTT连接测试

```bash
# 运行测试脚本
python test_mqtt_realtime.py

# 检查点:
✓ MQTT连接成功
✓ 成功订阅主题
✓ 收到位姿数据
✓ GPS坐标在合理范围内 (纬度20-30, 经度110-120)
✓ 高度在合理范围内 (10-500米)
```

#### 测试2：RTSP连接测试

```bash
# 方法1: 使用ffplay
ffplay -rtsp_transport tcp rtsp://192.168.1.100:8554/live

# 方法2: 使用测试脚本
python test_rtsp_connection.py

# 检查点:
✓ RTSP连接成功
✓ 视频能够正常播放
✓ 帧率稳定 (25-30 FPS)
✓ 延迟 < 1秒
```

#### 测试3：数据同步测试

```bash
# 运行同步测试
python test_data_sync.py

# 检查点:
✓ 视频帧能够匹配到位姿数据
✓ 时间差 < 200ms
✓ 匹配成功率 > 95%
```

### 6.2 集成测试

#### 测试场景1：短时间实时处理 (5分钟)

**测试步骤**：
1. 启动系统：`python run_realtime.py`
2. 确认RTSP和MQTT连接成功
3. 让无人机起飞并飞越检测目标
4. 观察实时显示画面
5. 运行5分钟后按Ctrl+C停止
6. 检查输出结果

**检查点**：
- ✅ 系统正常启动，无报错
- ✅ 检测框正确标注在目标上
- ✅ GPS坐标正确显示
- ✅ CSV文件生成，包含检测记录
- ✅ 截图文件保存正确

#### 测试场景2：长时间稳定性测试 (30分钟)

**测试步骤**：
1. 启动系统
2. 持续运行30分钟
3. 记录性能指标
4. 停止并分析日志

**检查点**：
- ✅ 无崩溃、无卡死
- ✅ 内存占用稳定，无内存泄漏
- ✅ 处理帧率稳定
- ✅ 检测结果持续输出

#### 测试场景3：网络异常恢复测试

**测试步骤**：
1. 启动系统，正常运行
2. 人为断开MQTT连接（拔网线或关闭防火墙）
3. 等待30秒
4. 恢复网络连接
5. 观察系统是否自动重连

**检查点**：
- ✅ 检测到网络断开，输出日志
- ✅ 自动尝试重连
- ✅ 重连成功后继续正常工作
- ✅ 数据不丢失（或丢失在可接受范围内）

### 6.3 性能测试

#### 测试指标统计

运行以下命令启动性能监控：

```bash
# 启动系统并记录性能
python run_realtime.py --enable-profiling

# 或使用监控脚本
python tools/monitor_performance.py
```

**记录以下指标**：

| 指标 | 测量方法 | 目标值 | 实际值 | 是否达标 |
|------|---------|--------|--------|---------|
| 处理帧率 | 日志统计 | > 20 FPS |  |  |
| 端到端延迟 | 时间戳差值 | < 500ms |  |  |
| YOLO推理时间 | 单帧推理耗时 | < 50ms |  |  |
| 坐标转换时间 | 单次转换耗时 | < 5ms |  |  |
| GPU显存占用 | nvidia-smi | < 5GB |  |  |
| CPU占用率 | 任务管理器 | < 60% |  |  |
| 内存占用 | 任务管理器 | < 8GB |  |  |
| MQTT延迟 | 收到消息时间差 | < 100ms |  |  |
| RTSP延迟 | 接收帧时间差 | < 500ms |  |  |

### 6.4 精度测试

#### GPS坐标精度验证

**测试方法**：

1. **选择已知地标**
   - 在石马河流域选择5-10个明显地标（如桥梁、建筑物）
   - 使用高精度GPS设备测量地标真实坐标
   - 记录真实坐标（Ground Truth）

2. **进行检测**
   - 让无人机飞越这些地标
   - 系统检测并计算GPS坐标
   - 记录检测坐标

3. **计算误差**
   ```python
   def calculate_gps_error(true_lat, true_lon, detected_lat, detected_lon):
       """计算GPS坐标误差 (米)"""
       from math import radians, cos, sin, sqrt, atan2
       
       R = 6371000  # 地球半径(米)
       
       lat1 = radians(true_lat)
       lat2 = radians(detected_lat)
       delta_lat = radians(detected_lat - true_lat)
       delta_lon = radians(detected_lon - true_lon)
       
       a = sin(delta_lat/2)**2 + cos(lat1)*cos(lat2)*sin(delta_lon/2)**2
       c = 2 * atan2(sqrt(a), sqrt(1-a))
       
       distance = R * c
       return distance
   ```

4. **评估结果**

| 地标ID | 真实坐标 | 检测坐标 | 误差(米) | 是否合格(<5米) |
|-------|---------|---------|---------|--------------|
| 1 | (22.7799, 114.1009) | (22.7800, 114.1010) | 3.2 | ✅ |
| 2 | (22.7850, 114.1050) | (22.7851, 114.1049) | 2.8 | ✅ |
| ... | ... | ... | ... | ... |

**目标精度**：
- 平均误差 < 5米
- 95%检测结果误差 < 10米
- 最大误差 < 20米

---

## 七、故障排查指南

### 7.1 MQTT连接问题

#### 问题1：连接失败，返回码5 (认证失败)

**现象**：
```
[ERROR] MQTT connection failed: Connection Refused: not authorised.
```

**可能原因**：
1. App Key或App Secret错误
2. 设备未绑定到应用
3. 认证信息包含多余空格或换行

**排查步骤**：
1. 检查配置文件中的username和password
2. 在DJI开发者平台重新复制App Key和App Secret
3. 确认设备已绑定到应用
4. 使用MQTTX工具独立测试

**解决方案**：
```yaml
# 确保没有多余空格
mqtt:
  username: "1234567890abcdef"  # 正确
  # username: " 1234567890abcdef "  # 错误：有空格
```

#### 问题2：连接成功但收不到数据

**现象**：
```
[INFO] MQTT连接成功
[INFO] 已订阅主题: thing/product/1581F5BKD233200012AB/state
[WARNING] 30秒内未收到位姿数据
```

**可能原因**：
1. 设备SN码错误
2. 设备未在线（无人机未开机）
3. 主题订阅错误
4. 设备没有推送数据到该主题

**排查步骤**：
1. 确认设备SN码：
   ```bash
   # 在DJI Pilot 2中查看设备信息
   # 对比配置文件中的SN码
   ```

2. 确认设备在线：
   - 查看DJI开发者平台"设备管理"
   - 设备状态应显示为"在线"

3. 使用通配符测试：
   ```yaml
   topics:
     aircraft_state: "thing/product/+/state"  # +表示通配符
   ```
   如果能收到数据，说明SN码有误

4. 查看MQTT日志：
   ```python
   # 在mqtt_client.py中增加调试日志
   def on_message(self, client, userdata, msg):
       print(f"收到消息: 主题={msg.topic}, 内容={msg.payload}")
   ```

**解决方案**：
- 更正设备SN码
- 确保设备在线
- 联系DJI技术支持确认主题格式

#### 问题3：消息格式解析失败

**现象**：
```
[ERROR] 解析位姿数据失败: KeyError: 'latitude'
```

**可能原因**：
- DJI实际消息格式与代码不符
- 字段名称或嵌套层级不同

**排查步骤**：
1. 在MQTTX中查看原始消息
2. 对比实际格式与代码中的字段路径
3. 打印原始JSON：
   ```python
   import json
   print(json.dumps(payload, indent=2))
   ```

**解决方案**：
修改 `src/input/mqtt_client.py` 中的字段提取逻辑。

### 7.2 RTSP连接问题

#### 问题1：连接超时

**现象**：
```
[ERROR] RTSP connection timeout: rtsp://192.168.1.100:8554/live
```

**可能原因**：
1. IP地址或端口错误
2. 网络不通
3. RTSP服务未启动
4. 防火墙阻止

**排查步骤**：
1. Ping测试：
   ```bash
   ping 192.168.1.100
   ```

2. 端口测试：
   ```bash
   telnet 192.168.1.100 8554
   ```

3. VLC播放测试：
   ```bash
   vlc rtsp://192.168.1.100:8554/live
   ```

4. 检查防火墙：
   - Windows防火墙
   - 路由器防火墙

**解决方案**：
- 更正RTSP地址
- 确保网络连通
- 关闭防火墙或添加例外规则

#### 问题2：视频卡顿、花屏

**现象**：
- 视频播放不流畅
- 出现马赛克或花屏
- 帧率不稳定

**可能原因**：
1. 网络带宽不足
2. 传输协议不合适（UDP丢包）
3. 视频编码问题

**排查步骤**：
1. 测试网络带宽：
   ```bash
   # 使用iperf测试
   iperf3 -c 192.168.1.100
   ```

2. 切换传输协议：
   ```yaml
   rtsp:
     transport_protocol: "tcp"  # 尝试TCP
   ```

3. 降低视频分辨率（在图传端设置）

**解决方案**：
- 使用有线网络代替WiFi
- 使用TCP传输协议
- 降低视频码率

### 7.3 数据同步问题

#### 问题1：大量帧无法匹配位姿数据

**现象**：
```
[WARNING] Frame 12345 no matching pose (skipped)
[WARNING] Frame 12346 no matching pose (skipped)
...
```

**可能原因**：
1. MQTT推送延迟过大
2. 时间戳不同步
3. max_time_diff设置过小

**排查步骤**：
1. 检查时间差：
   ```python
   print(f"Frame timestamp: {frame_ts}")
   print(f"Pose timestamp: {pose_ts}")
   print(f"Time diff: {abs(frame_ts - pose_ts)}ms")
   ```

2. 查看位姿缓冲区大小：
   ```python
   print(f"Pose buffer size: {len(pose_buffer)}")
   ```

**解决方案**：
```yaml
data_sync:
  max_time_diff: 500  # 增大到500ms
  pose_buffer_size: 200  # 增大缓冲区
```

### 7.4 检测精度问题

#### 问题1：GPS坐标偏差过大 (>50米)

**可能原因**：
1. 相机参数配置错误
2. 高度数据不准确
3. 时间同步失败

**排查步骤**：
1. 验证相机参数：
   ```yaml
   # 检查config/camera_params.yaml
   # 确认分辨率、传感器尺寸、焦距与实际相机一致
   ```

2. 检查高度数据：
   ```python
   # 打印高度值
   print(f"Altitude: {pose['altitude']}m")
   # 确认是否合理（通常50-200米）
   ```

3. 检查时间同步：
   ```python
   # 打印时间差
   print(f"Sync time diff: {time_diff}ms")
   # 应该 < 200ms
   ```

**解决方案**：
- 使用无人机实际相机参数
- 确认使用正确的高度字段（altitude或height）
- 提高时间同步精度

---

## 八、性能优化建议

### 8.1 提高处理速度

#### 优化1：降低YOLO推理尺寸

```yaml
# config/yolo_config.yaml
detection:
  imgsz: 640  # 从1280降低到640
  # 说明: 推理速度提升2-3倍，精度略有下降
```

#### 优化2：启用跳帧处理

```yaml
# config/realtime_config.yaml
realtime_processing:
  frame_skip: 2  # 每2帧处理1次
  # 说明: 处理速度提升1倍，但可能漏检快速移动目标
```

#### 优化3：启用半精度推理

```yaml
# config/yolo_config.yaml
model:
  half_precision: true
  # 说明: GPU显存占用减半，速度提升30-50%
  # 要求: GPU支持FP16 (如RTX系列)
```

### 8.2 降低资源占用

#### 优化4：减少缓冲区大小

```yaml
# config/realtime_config.yaml
rtsp:
  buffer_size: 10  # 从30降低到10
  
mqtt:
  pose_buffer_size: 50  # 从100降低到50
```

#### 优化5：关闭实时显示

```yaml
# config/realtime_config.yaml
visualization:
  realtime_display: false  # 关闭实时显示
  # 说明: 节省10-20% CPU占用
```

#### 优化6：裁剪截图

```yaml
# config/realtime_config.yaml
output:
  image_format: "crop"  # 只保存目标区域
  # 说明: 磁盘占用减少80%
```

### 8.3 提高稳定性

#### 优化7：增加重连次数

```yaml
rtsp:
  max_reconnect_attempts: 0  # 无限重连
  reconnect_interval: 3  # 3秒重连一次

mqtt:
  reconnect_interval: 3
```

#### 优化8：启用错误帧保存

```yaml
error_handling:
  save_error_frames: true
  error_frame_dir: "./data/output/error_frames/"
  # 说明: 便于排查问题
```

---

## 九、附录

### 附录A：完整配置文件示例

见 `config/realtime_config.yaml`（已在前文详细说明）

### 附录B：关键代码文件清单

| 文件路径 | 功能说明 | 关键方法 |
|---------|---------|---------|
| `src/realtime_pipeline.py` | 实时处理主流程 | `run()` |
| `src/input/rtsp_stream_reader.py` | RTSP视频流读取 | `connect()`, `read_frame()` |
| `src/input/mqtt_client.py` | MQTT位姿数据接收 | `connect()`, `get_latest_pose()` |
| `src/utils/data_sync.py` | 数据同步 | `find_closest_pose()` |
| `src/detection/yolo_detector.py` | YOLO检测 | `detect()` |
| `src/transform/coord_transform.py` | 坐标转换 | `pixel_to_gps()` |
| `src/output/csv_writer.py` | CSV输出 | `write_detection()` |

### 附录C：常用命令速查

| 操作 | 命令 |
|------|------|
| 启动实时处理 | `python run_realtime.py` |
| 测试MQTT连接 | `python test_mqtt_realtime.py` |
| 测试RTSP播放 | `vlc rtsp://IP:PORT/PATH` |
| 查看GPU状态 | `nvidia-smi` |
| 查看实时日志 | `tail -f data/output/realtime_log.txt` |
| 生成地图 | `python tools/quick_visualize.py` |

### 附录D：联系方式

| 角色 | 姓名 | 联系方式 |
|------|------|---------|
| 项目负责人 | [填写] | [填写] |
| 算法工程师 | [填写] | [填写] |
| 后端开发 | [填写] | [填写] |
| 硬件工程师 | [填写] | [填写] |
| DJI技术支持 | - | https://developer.dji.com/support |

---

## 十、总结

### 10.1 核心要点

1. **RTSP提供视频画面**，用于YOLO目标检测
2. **MQTT提供位姿数据**，用于计算目标GPS坐标
3. **数据同步是关键**，确保视频帧与位姿数据时间匹配
4. **配置准确性很重要**，特别是相机参数直接影响定位精度

### 10.2 开发重点

- ✅ 首先完成MQTT和RTSP的连接测试
- ✅ 确认数据格式，必要时修改解析代码
- ✅ 验证数据同步机制的准确性
- ✅ 测试长时间运行的稳定性
- ✅ 验证GPS坐标精度

### 10.3 验收标准

| 项目 | 标准 |
|------|------|
| MQTT连接 | 连接成功率 100%，推送频率稳定 |
| RTSP连接 | 连接成功率 > 99%，断流自动重连 |
| 数据同步 | 匹配成功率 > 95%，时间差 < 200ms |
| 检测精度 | 准确率 > 85%，召回率 > 80% |
| 定位精度 | GPS坐标误差 < 5米 |
| 处理性能 | 帧率 > 20 FPS，延迟 < 500ms |
| 稳定性 | 连续运行30分钟无崩溃 |

---

**文档编制**：无人机巡检系统开发团队  
**最后更新**：2026年2月12日  
**版本号**：v1.0
