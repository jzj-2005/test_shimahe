# v2.1新功能快速启动指南

**5分钟上手GeoJSON输出和智能去重功能**

---

## 第一步：确认环境（30秒）

```bash
# 确认项目路径
cd d:\jzj\siluan_new

# 确认Python环境
python --version
# 应该显示 Python 3.8+ 版本
```

---

## 第二步：配置文件（1分钟）

**方式A：使用默认配置（推荐）**

无需修改任何配置文件！离线模式默认已开启所有新功能。

**方式B：自定义配置（可选）**

编辑 `config/offline_config.yaml`：

```yaml
output:
  # 如果想检测完成后自动打开地图查看
  auto_open_map: true              # 改为true
  
  # 如果想调整去重敏感度
  deduplication:
    distance_threshold: 3.0        # 从5米改为3米（更严格）
```

---

## 第三步：运行检测（2分钟）

**使用测试视频**：

```bash
# 如果有测试视频
python src/main.py --mode offline --video data/input/videos/test.mp4

# 或使用任何MP4视频
python src/main.py --mode offline --video <你的视频路径>
```

**等待完成**：

```
[INFO] 开始离线视频处理...
[INFO] 总帧数: 300, 跳帧间隔: 5
...
[INFO] 处理完成: 检测到 523 个目标
[INFO] ====== 开始后处理 ======
[INFO] 读取检测数据: 523 条记录
[INFO] 去重完成: 523 -> 156 条 (去重率 70.2%)
[INFO] ✓ 导出原始GeoJSON: detections_raw.geojson (523条)
[INFO] ✓ 导出去重GeoJSON: detections_unique.geojson (156条)
[INFO] ✓ 导出高置信度GeoJSON: detections_high_conf.geojson (105条)
[INFO] ✓ 生成HTML地图: map.html
[INFO] ✓ 生成统计摘要: summary.txt
[INFO] ✓ 后处理完成
```

---

## 第四步：查看结果（1分钟）

### 方式1：查看地图（推荐，最直观）

```bash
# Windows
start data\output\map.html

# 或直接双击文件
```

**地图功能**：
- 🗺️ 在OpenStreetMap上显示所有检测
- 🎨 不同颜色区分类别
- 🖱️ 点击查看详细信息
- 📊 右下角图例显示类别统计

### 方式2：查看统计摘要

```bash
notepad data\output\summary.txt
```

**查看内容**：
- 检测数量（原始、去重后）
- 类别分布
- 置信度统计
- GPS质量分布
- 覆盖范围

### 方式3：导入GIS软件（可选）

**QGIS**：

```
1. 打开QGIS
2. 图层 → 添加图层 → 添加矢量图层...
3. 选择: d:\jzj\siluan_new\data\output\geojson\detections_unique.geojson
4. 右键图层 → 属性 → 符号系统 → 分类 → 字段选择"class_name"
5. 点击"分类"按钮
```

---

## 快速问答

### Q: 如何关闭去重，查看所有原始数据？

```yaml
# config/offline_config.yaml
output:
  enable_deduplication: false
```

### Q: 如何让地图自动打开？

```yaml
output:
  auto_open_map: true
```

### Q: 实时模式也能用这些功能吗？

可以，但需要注意：

```yaml
# config/realtime_config.yaml
output:
  export_geojson: true             # 需要手动改为true
  enable_deduplication: true       # 必须开启（否则数据量巨大）
  generate_map: false              # 建议关闭（数据量大，加载慢）
  generate_summary: true           # 建议开启
```

### Q: 生成的文件在哪里？

```
data/output/
├── csv/detections_offline.csv                  # CSV原始数据
├── geojson/
│   ├── detections_raw.geojson                  # GeoJSON原始
│   ├── detections_unique.geojson               # GeoJSON去重（推荐）
│   └── detections_high_conf.geojson            # 高置信度
├── map.html                                    # HTML地图
└── summary.txt                                 # 统计摘要
```

### Q: 哪个GeoJSON文件导入GIS？

推荐使用 `detections_unique.geojson`（智能去重后的）：
- ✅ 数据清晰，无重复
- ✅ 已保留最佳质量检测
- ✅ 文件小，加载快

### Q: 如果功能不工作怎么办？

**检查清单**：

1. 配置文件中 `export_geojson: true`
2. CSV文件有数据
3. 查看日志 `data/output/offline_log.txt`
4. 运行测试脚本 `python test_post_processing.py`

---

## 完整示例

### 典型工作流程

```bash
# 1. 准备视频
copy test.mp4 data\input\videos\

# 2. 运行检测（自动生成所有输出）
python src/main.py --mode offline --video data\input\videos\test.mp4

# 3. 查看地图（自动生成）
start data\output\map.html

# 4. 查看摘要
notepad data\output\summary.txt

# 5. 导入GIS（如需要）
# 在QGIS中导入 data/output/geojson/detections_unique.geojson

# 完成！
```

---

## 测试脚本

如果想测试后处理功能（不重新运行检测）：

```bash
# 前提：已经有CSV文件
python test_post_processing.py

# 会生成测试文件：
# - map_test.html
# - summary_test.txt
# - geojson/detections_*.geojson
```

---

## 性能参考

| 数据量 | 去重耗时 | 导出GeoJSON | 生成地图 | 总耗时 |
|--------|---------|------------|---------|--------|
| 100条 | 0.08s | 0.15s | 0.10s | ~0.4s |
| 1000条 | 0.52s | 0.35s | 0.18s | ~1.2s |
| 10000条 | 5.3s | 2.8s | 1.5s | ~11s |

**结论**：后处理非常快，不影响整体性能。

---

## 故障排查

### 症状：检测完成后没有生成GeoJSON

**原因1**：配置未开启

```yaml
# 检查 config/offline_config.yaml
export_geojson: true  # 确认是true
```

**原因2**：CSV为空

```bash
# 检查CSV文件大小
ls -lh data/output/csv/detections_offline.csv
# 如果为空，说明检测未找到目标
```

### 症状：地图打开是空白

**原因**：需要网络加载Leaflet.js

**解决**：
- 确保有网络连接
- 或使用Chrome/Firefox（不要用IE）

---

## 总结

✅ **5分钟完成配置和测试**  
✅ **自动生成所有输出文件**  
✅ **无需手动运行额外脚本**  
✅ **完全向后兼容**

**关键点**：

1. 离线模式默认开启所有功能
2. 检测完成后自动执行后处理
3. 智能去重大幅减少数据冗余
4. 生成的文件可直接用于GIS和汇报

**下一步**：

- 📖 详细了解：阅读 `GeoJSON和地图输出使用指南.md`
- 🔬 技术细节：阅读 `GeoJSON输出和智能去重实现文档.md`
- 🏃 开始使用：运行你的实际巡检视频

---

**编写日期**: 2026-02-25  
**版本**: v2.1.0
