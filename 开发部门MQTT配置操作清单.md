# 开发部门MQTT配置操作清单

**文档类型**：操作手册  
**目标读者**：开发部门技术人员  
**设备型号**：DJI M3TD / M4TD  
**系统名称**：石马河四乱检测系统 - 实时流处理模块  
**版本**：v1.0  
**日期**：2026年2月12日

---

## 使用说明

本文档提供**完整的分步操作指南**，帮助开发部门快速完成M3TD/M4TD无人机的MQTT实时数据流配置。

**预计完成时间**：2-3小时  
**前置条件**：已完成离线视频处理流程测试

---

## 第一部分：准备工作（预计30分钟）

### 任务1.1：注册DJI开发者账号

**负责人**：项目负责人或开发组长  
**优先级**：P0（必须完成）

#### 操作步骤：

1. **访问DJI开发者平台**
   ```
   URL: https://developer.dji.com/
   ```

2. **注册账号**
   - 点击页面右上角"注册"按钮
   - 选择账号类型：
     - 个人开发者（适合测试）
     - 企业开发者（推荐生产环境）
   - 填写基本信息：
     - 邮箱地址
     - 密码
     - 手机号
   - 完成邮箱验证

3. **完善开发者信息**
   - 登录后进入"个人中心"
   - 填写开发者资料
   - 企业用户需要上传营业执照

#### 验收标准：
- [ ] 能够成功登录DJI开发者平台
- [ ] 开发者信息已完善
- [ ] 收到注册成功邮件

---

### 任务1.2：创建应用并获取认证信息

**负责人**：开发组长  
**优先级**：P0（必须完成）

#### 操作步骤：

1. **进入控制台**
   - 登录DJI开发者平台
   - 点击顶部导航栏"控制台"

2. **创建新应用**
   - 点击"创建应用"按钮
   - 填写应用信息：
     ```
     应用名称：石马河四乱检测系统
     应用类型：云服务应用 ⚠️ 必须选择此类型
     应用描述：基于M3TD/M4TD的水利四乱自动检测系统
     应用分类：智慧城市 / 水利监测
     ```
   - 点击"确认创建"

3. **获取认证信息**
   - 创建成功后，进入"应用详情"页面
   - 找到并**复制保存**以下信息：
     - ✅ **App ID**（应用标识）
     - ✅ **App Key**（应用密钥，MQTT用户名）
     - ✅ **App Secret**（应用密码，MQTT密码）
     - ✅ **App License**（应用许可证）

4. **保存到安全位置**
   - 将上述信息保存到密码管理器或安全文档
   - ⚠️ **重要**：App Secret只显示一次，请务必保存！
   - 如果丢失，需要重新生成（会导致旧密钥失效）

#### 记录表格：

| 项目 | 值 | 备注 |
|------|-----|------|
| App ID | `________________` | 应用唯一标识 |
| App Key | `________________` | MQTT用户名 |
| App Secret | `________________` | MQTT密码（保密） |
| App License | `________________` | 应用许可证 |

#### 验收标准：
- [ ] 应用创建成功
- [ ] App ID、App Key、App Secret已保存
- [ ] 应用状态显示为"正常"

---

### 任务1.3：绑定M3TD/M4TD设备并获取SN码

**负责人**：硬件工程师 + 开发组长  
**优先级**：P0（必须完成）

#### 操作步骤：

**方法1：从DJI Pilot 2查看（推荐）**

1. **连接设备**
   - 开启M3TD/M4TD无人机或机场
   - 打开DJI Pilot 2 App
   - 等待设备连接成功

2. **查看设备SN**
   - 进入App设置
   - 导航路径：设置 → 关于 → 设备信息
   - 找到"序列号（SN）"字段
   - 记录设备SN（15-20位字母数字组合）
   - 示例：`1581F5BKD233200012AB`

**方法2：从机场设备查看**

1. 登录机场管理界面
   - 浏览器访问机场IP地址（通常 `http://192.168.1.x`）
   - 输入管理员账号密码

2. 查看设备信息
   - 进入"系统信息"或"设备信息"页面
   - 找到设备序列号

**方法3：从设备外壳查看**

- 查看机场或无人机外壳上的标签
- 找到标注为"SN"或"序列号"的字段

#### 在DJI平台绑定设备：

1. **进入应用详情**
   - 登录DJI开发者平台
   - 进入"石马河四乱检测系统"应用详情

2. **添加设备**
   - 找到"设备管理"选项卡
   - 点击"添加设备"
   - 输入设备SN码
   - 或扫描设备二维码
   - 点击"绑定"

3. **验证绑定**
   - 确认设备列表中显示已绑定设备
   - 设备状态显示为"在线"或"离线"

#### 记录表格：

| 设备类型 | 设备SN码 | 绑定状态 | 备注 |
|---------|---------|---------|------|
| M3TD/M4TD | `________________` | ☐ 已绑定 | 主要设备 |
| 机场（如有） | `________________` | ☐ 已绑定 | 可选 |

#### 验收标准：
- [ ] 设备SN码已记录
- [ ] 设备已在DJI平台绑定到应用
- [ ] 设备在DJI平台显示在线状态

---

## 第二部分：配置文件修改（预计30分钟）

### 任务2.1：修改MQTT配置文件

**负责人**：后端开发工程师  
**优先级**：P0（必须完成）  
**文件路径**：`config/realtime_config.yaml`

#### 操作步骤：

1. **打开配置文件**
   ```bash
   # 使用文本编辑器打开
   notepad config/realtime_config.yaml
   # 或使用VS Code
   code config/realtime_config.yaml
   ```

2. **修改MQTT认证信息**
   
   找到以下行并修改：
   
   ```yaml
   mqtt:
     broker: "mqtt-cn.dji.com"  # ✅ 中国大陆用户保持不变
     port: 1883                 # ✅ 保持不变（生产环境可改为8883）
     
     # ⚠️ 以下三项必须修改：
     username: "[请填写DJI App Key]"       # 替换为任务1.2中的App Key
     password: "[请填写DJI App Secret]"    # 替换为任务1.2中的App Secret
     client_id: "stone_river_inspection_realtime_001"  # 可自定义，保持唯一
   ```

3. **修改OSD主题配置**
   
   找到 `topics` 部分并修改：
   
   ```yaml
   topics:
     # ⚠️ 必须修改：将设备SN填入
     aircraft_state: "thing/product/[请填写M3TD/M4TD设备SN]/osd"
   ```
   
   **修改示例**：
   ```yaml
   # 修改前：
   aircraft_state: "thing/product/[请填写M3TD/M4TD设备SN]/osd"
   
   # 修改后（假设SN为1581F5BKD233200012AB）：
   aircraft_state: "thing/product/1581F5BKD233200012AB/osd"
   ```

4. **保存文件**
   - 按 `Ctrl+S` 保存
   - 检查YAML格式是否正确（注意缩进）

#### 配置检查清单：

```yaml
mqtt:
  broker: "mqtt-cn.dji.com"                     # ✅ 已确认
  port: 1883                                     # ✅ 已确认
  username: "你的App Key"                        # ⚠️ 已填写
  password: "你的App Secret"                     # ⚠️ 已填写
  client_id: "stone_river_inspection_xxx"       # ⚠️ 已填写
  topics:
    aircraft_state: "thing/product/你的设备SN/osd"  # ⚠️ 已填写
```

#### 验收标准：
- [ ] `username` 已填写为实际App Key
- [ ] `password` 已填写为实际App Secret
- [ ] `aircraft_state` 主题中的设备SN已替换
- [ ] 主题以 `/osd` 结尾（不是 `/state`）
- [ ] YAML格式正确，无语法错误

---

### 任务2.2：修改RTSP配置（如需要）

**负责人**：硬件工程师 + 后端开发  
**优先级**：P1（重要）  
**文件路径**：`config/realtime_config.yaml`

#### 操作步骤：

1. **获取RTSP地址**
   
   **方法1：从机场获取**
   - 登录机场管理界面
   - 进入"视频流"或"RTSP配置"页面
   - 复制RTSP地址
   - 格式示例：`rtsp://192.168.1.100:8554/live`

   **方法2：从图传设备配置**
   - 在DJI Pilot 2中开启RTSP推流
   - 设置推流目标地址为地面站IP
   - 记录RTSP端口（默认554或8554）

2. **修改配置文件**
   
   找到以下行并修改：
   
   ```yaml
   rtsp:
     url: "rtsp://192.168.1.100:8554/live"  # ⚠️ 修改为实际RTSP地址
     transport_protocol: "tcp"               # tcp或udp，建议tcp
   ```

#### 验收标准：
- [ ] RTSP地址已修改为实际地址
- [ ] 能够使用VLC播放器播放该RTSP流
- [ ] 传输协议已设置（tcp或udp）

---

## 第三部分：测试验证（预计1小时）

### 任务3.1：运行MQTT连接测试

**负责人**：后端开发工程师  
**优先级**：P0（必须完成）

#### 操作步骤：

1. **激活Python环境**
   ```bash
   conda activate drone_inspection
   ```

2. **运行测试脚本**
   ```bash
   python test_mqtt_realtime.py
   ```

3. **查看测试输出**
   
   **预期输出**：
   ```
   ===========================================================
   MQTT连接测试
   ===========================================================
   
   [1/6] 加载配置文件
   ------------------------------------------------------------
     ✅ 配置文件加载成功
   
   [2/6] 连接MQTT服务器
   ------------------------------------------------------------
   正在连接MQTT服务器...
     ✅ MQTT连接成功!
   
   [3/6] 查看原始OSD数据格式（可选）
   ------------------------------------------------------------
   是否显示原始OSD数据格式? (y/n，建议首次配置选y): y
   
   ===========================================================
   原始OSD数据监控
   ===========================================================
   
   [1] 接收到原始OSD数据:
   {
     "tid": "xxx",
     "bid": "xxx",
     "timestamp": 1707730815123,
     "data": {
       "latitude": 22.779954,
       "longitude": 114.100891,
       "altitude": 139.231,
       ...
     }
   }
   
   [4/6] 等待解析后的位姿数据
   ------------------------------------------------------------
     ✅ 成功接收并解析位姿数据! (第3秒)
   
   [5/6] 显示位姿数据详情
   ------------------------------------------------------------
     GPS纬度: 22.779954°
     GPS经度: 114.100891°
     海拔高度: 139.23 米
     ✅ 测试通过! MQTT位姿数据接收正常
   ```

4. **记录OSD数据格式**
   
   如果实际数据格式与预期不同，请记录：
   - 实际的字段名称
   - 数据嵌套结构
   - 截图保存

#### 常见问题排查：

**问题1：连接失败，返回码5**
```
[ERROR] MQTT connection failed: Connection Refused: not authorised.
```
**原因**：App Key或App Secret错误  
**解决**：
1. 重新检查 `config/realtime_config.yaml` 中的username和password
2. 确保没有多余的空格或换行
3. 重新从DJI平台复制App Key和App Secret

**问题2：连接成功但无数据**
```
[WARNING] 30秒内未接收到位姿数据
```
**原因**：设备SN错误或设备未在线  
**解决**：
1. 检查设备SN是否正确
2. 确认设备在线（DJI Pilot 2中查看）
3. 检查主题是否以 `/osd` 结尾

**问题3：数据格式解析失败**
```
[ERROR] 处理OSD数据时发生错误: KeyError: 'latitude'
```
**原因**：OSD数据格式与预期不同  
**解决**：
1. 查看原始OSD数据（测试脚本会显示）
2. 记录实际字段名称
3. 联系技术支持调整代码

#### 验收标准：
- [ ] 测试脚本运行无错误
- [ ] MQTT连接成功
- [ ] 能够接收OSD数据
- [ ] GPS坐标、高度、姿态数据解析正确
- [ ] 数据推送频率约10Hz

---

### 任务3.2：运行完整系统测试

**负责人**：后端开发 + 算法工程师  
**优先级**：P0（必须完成）

#### 操作步骤：

1. **确保设备在线**
   - M3TD/M4TD无人机已开机并飞行
   - 或机场已通电且无人机已起飞

2. **启动实时处理系统**
   ```bash
   python run_realtime.py
   ```

3. **观察系统运行**
   
   **预期输出**：
   ```
   [INFO] 连接RTSP流: rtsp://192.168.1.100:8554/live
   [INFO] 连接MQTT: mqtt-cn.dji.com:1883
   [INFO] RTSP连接成功
   [INFO] MQTT连接成功
   [INFO] 已订阅主题: aircraft_state -> thing/product/xxx/osd
   [INFO] 开始实时处理...
   [INFO] 接收OSD数据: GPS(22.7799, 114.1009) WGS84, 高度139.2m
   [INFO] 检测到目标: Vegetation, 置信度: 0.85
   [INFO] 坐标转换成功: (22.7801, 114.1012) CGCS2000
   ```

4. **检查输出结果**
   
   - **CSV文件**：`data/output/csv/detections_realtime.csv`
   - **检测截图**：`data/output/images/realtime/`
   - **日志文件**：`data/output/realtime_log.txt`

5. **运行5分钟测试**
   - 让系统持续运行5分钟
   - 观察是否有检测结果
   - 检查是否有错误或警告

6. **停止系统**
   - 按 `Ctrl+C` 或窗口中按 `Esc` 键
   - 确认CSV文件已保存

#### 性能指标检查：

| 指标 | 目标值 | 实际值 | 是否达标 |
|------|--------|--------|---------|
| 处理帧率 | > 20 FPS | _____ | ☐ |
| MQTT延迟 | < 200ms | _____ | ☐ |
| GPS解析成功率 | > 95% | _____ | ☐ |
| 内存占用 | < 8GB | _____ | ☐ |
| GPU显存占用 | < 5GB | _____ | ☐ |

#### 验收标准：
- [ ] 系统成功启动无报错
- [ ] RTSP和MQTT均连接成功
- [ ] 能够实时接收OSD数据
- [ ] 检测功能正常工作
- [ ] CSV文件正确生成
- [ ] 处理帧率 > 20 FPS

---

### 任务3.3：GPS坐标精度验证

**负责人**：算法工程师  
**优先级**：P1（重要）

#### 操作步骤：

1. **生成交互式地图**
   ```bash
   python tools/quick_visualize.py
   ```

2. **在浏览器中打开地图**
   - 文件路径：`data/output/map.html`
   - 双击打开或拖入浏览器

3. **验证坐标准确性**
   - 随机选择5-10个检测结果
   - 在地图上点击查看位置
   - 对比卫星图确认目标是否在正确位置
   - 目标误差应 < 5米

4. **记录验证结果**

| 检测ID | 目标类型 | 地图位置 | 实际位置 | 误差(米) | 是否合格 |
|-------|---------|---------|---------|---------|---------|
| 1 | Vegetation | (22.7801, 114.1012) | 目视确认 | ~3m | ✅ |
| 2 | Sheds | (22.7850, 114.1050) | 目视确认 | ~4m | ✅ |
| ... | ... | ... | ... | ... | ... |

#### 验收标准：
- [ ] 地图成功生成
- [ ] 检测目标显示在地图上
- [ ] 95%检测结果位置正确（误差<5米）
- [ ] 无明显系统性偏差

---

## 第四部分：文档更新（预计30分钟）

### 任务4.1：记录实际配置参数

**负责人**：项目负责人  
**优先级**：P2（建议完成）

#### 填写配置记录表：

```
========== 石马河四乱检测系统 - MQTT配置记录 ==========

配置日期：2026年__月__日
配置人员：___________

一、DJI开发者平台信息
  App ID: ___________________________
  App Key: __________________________
  应用名称：石马河四乱检测系统
  应用状态：☐ 正常

二、设备信息
  设备型号：☐ M3TD  ☐ M4TD
  设备SN码：_________________________
  设备状态：☐ 在线  ☐ 已绑定

三、MQTT配置
  Broker地址：mqtt-cn.dji.com
  端口：1883
  Client ID：stone_river_inspection_realtime_001
  订阅主题：thing/product/____________/osd

四、RTSP配置
  RTSP地址：rtsp://__________:____/____
  传输协议：☐ tcp  ☐ udp

五、测试结果
  MQTT连接：☐ 成功  ☐ 失败
  OSD数据接收：☐ 成功  ☐ 失败
  GPS解析：☐ 成功  ☐ 失败
  完整系统运行：☐ 成功  ☐ 失败
  坐标精度：☐ 合格(<5米)  ☐ 不合格

六、已知问题
  1. ________________________________
  2. ________________________________

七、备注
  ________________________________
  ________________________________

========== 记录完成 ==========
```

---

## 第五部分：故障排查快速参考

### 常见问题速查表

| 现象 | 可能原因 | 解决方案 |
|------|---------|---------|
| MQTT连接失败(返回码5) | App Key/Secret错误 | 重新检查配置文件中的认证信息 |
| 连接成功但无数据 | 设备SN错误或设备离线 | 1. 检查SN码<br>2. 确认设备在线 |
| OSD数据解析失败 | 数据格式不匹配 | 查看原始OSD数据，记录实际字段名 |
| GPS坐标为0 | OSD数据中无GPS字段 | 检查设备是否开启GPS推送 |
| 坐标偏差过大(>50米) | 相机参数配置错误 | 检查`camera_params.yaml`配置 |
| 处理速度慢(<10fps) | GPU性能不足 | 1. 降低`imgsz`到640<br>2. 启用`frame_skip` |
| 系统崩溃或卡死 | 内存泄漏 | 重启系统，检查日志 |

### 紧急联系方式

| 角色 | 姓名 | 联系方式 | 负责范围 |
|------|------|---------|---------|
| 项目负责人 | _____ | _____ | 整体协调 |
| 算法工程师 | _____ | _____ | 检测精度问题 |
| 后端开发 | _____ | _____ | MQTT/代码问题 |
| 硬件工程师 | _____ | _____ | RTSP/设备问题 |

---

## 附录：参考文档

1. **DJI开发者文档**  
   https://developer.dji.com/doc/cloud-api-tutorial/cn/

2. **M3TD/M4TD用户手册**  
   查看设备附带的用户手册

3. **系统开发指南**  
   `无人机实时流处理配置与开发指南.md`

4. **测试脚本说明**  
   `test_mqtt_realtime.py` - 查看文件头部注释

5. **配置文件模板**  
   `config/realtime_config.yaml`

---

## 完成确认

配置完成后，请确认以下所有项：

### 配置完成检查清单

- [ ] **准备工作**
  - [ ] DJI开发者账号已注册
  - [ ] 应用已创建，App Key/Secret已获取
  - [ ] M3TD/M4TD设备已绑定，SN码已记录

- [ ] **配置文件**
  - [ ] `realtime_config.yaml` 中MQTT参数已填写
  - [ ] OSD主题配置正确（以/osd结尾）
  - [ ] RTSP地址已配置（如需要）

- [ ] **测试验证**
  - [ ] MQTT连接测试通过
  - [ ] OSD数据接收正常
  - [ ] 完整系统运行正常
  - [ ] GPS坐标精度合格

- [ ] **文档记录**
  - [ ] 配置参数已记录
  - [ ] 测试结果已记录
  - [ ] 已知问题已记录

### 最终签字确认

| 角色 | 姓名 | 签字 | 日期 |
|------|------|------|------|
| 项目负责人 | _____ | _____ | _____ |
| 开发组长 | _____ | _____ | _____ |
| 测试负责人 | _____ | _____ | _____ |

---

**文档编制**：无人机巡检系统开发团队  
**版本**：v1.0  
**最后更新**：2026年2月12日
