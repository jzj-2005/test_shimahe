# 增强版坐标转换器使用指南

## 快速开始

### 1. 启用增强版转换器

编辑 `config/camera_params.yaml`，找到以下配置并修改：

```yaml
coordinate_transform:
  use_enhanced: true  # 改为 true
```

### 2. 运行检测

```bash
# 实时模式
python run_realtime.py

# 离线模式
python run_offline.py "视频路径.MP4"
```

### 3. 查看结果

系统会自动：
- ✅ 使用3D姿态修正算法
- ✅ 评估GPS质量
- ✅ 过滤低质量数据
- ✅ 在CSV中添加质量标记

---

## 配置说明

### GPS质量控制（推荐配置）

```yaml
coordinate_transform:
  quality_control:
    enabled: true               # 是否启用质量控制
    min_gps_level: 3           # 最低GPS信号（1-5）
    min_satellite_count: 10    # 最少卫星数
    skip_on_low_quality: true  # 是否跳过低质量数据
```

**参数说明**：

- `min_gps_level`: GPS信号强度要求
  - 1-2: 信号很差
  - 3-4: 信号合格
  - 5: 信号优秀

- `min_satellite_count`: 卫星数量要求
  - <8: 定位不稳定
  - 8-12: 基本可用
  - >12: 定位稳定

- `skip_on_low_quality`: 
  - `true`: 自动跳过低质量数据（推荐）
  - `false`: 保留但标记质量等级

### 调整建议

**城市环境**（高楼遮挡）:
```yaml
min_gps_level: 2
min_satellite_count: 8
skip_on_low_quality: false  # 保留数据但标记
```

**空旷环境**（GPS信号好）:
```yaml
min_gps_level: 4
min_satellite_count: 12
skip_on_low_quality: true  # 严格过滤
```

---

## CSV输出说明

### 新增的质量信息列

| 列名 | 说明 | 示例值 |
|------|------|--------|
| `gps_quality` | GPS质量等级 | RTK / HIGH / MEDIUM / LOW |
| `positioning_state` | 定位状态 | RTK_FIXED / GPS / DGPS |
| `estimated_error` | 预估误差（米） | 0.05 / 2.5 / 5.0 |
| `gps_level` | GPS信号强度 | 0-5 |
| `satellite_count` | 卫星数量 | 18 / 12 / 8 |

### 质量等级说明

| 等级 | 精度 | 可靠性 | 建议用途 |
|------|------|--------|---------|
| **RTK** | 0.02-0.05米 | 极高 | 测量级应用 |
| **HIGH** | 0.5-3米 | 高 | 执法取证 |
| **MEDIUM** | 3-5米 | 中等 | 常规巡检 |
| **LOW** | 5-8米 | 较低 | 参考用 |
| **INVALID** | >10米 | 极低 | 已过滤 |

### 数据筛选

使用pandas筛选高质量数据：

```python
import pandas as pd

# 读取CSV
df = pd.read_csv('data/output/csv/detections_realtime.csv')

# 只保留高质量数据
high_quality = df[df['gps_quality'].isin(['RTK', 'HIGH'])]

# 只保留误差<3米的数据
accurate = df[df['estimated_error'] < 3.0]

# RTK数据（最高精度）
rtk_only = df[df['positioning_state'] == 'RTK_FIXED']
```

---

## OSD数据要求

### 必需字段（缺一不可）

```json
{
  "timestamp": 1707730815123,
  "data": {
    "latitude": 22.779954,
    "longitude": 114.100891,
    "altitude": 139.231,
    "pitch": -88.5,    // ← 关键
    "yaw": 45.2,       // ← 关键
    "roll": 0.1        // ← 关键
  }
}
```

### 推荐字段（质量控制）

```json
{
  "data": {
    "gps_level": 5,
    "satellite_count": 18,
    "positioning_state": "RTK_FIXED"
  }
}
```

---

## 测试验证

### 运行单元测试

```bash
# 基础测试
python tests/test_coord_transform_new.py

# 完整测试（需要pytest）
pytest tests/test_coord_transform_new.py -v
```

### 精度验证步骤

1. **选择已知地标**
   - 使用高德地图或实地测量获取真实GPS坐标

2. **运行检测**
   - 确保检测到该地标

3. **计算误差**
   ```python
   from geopy.distance import geodesic
   
   真实坐标 = (22.779954, 114.100891)
   检测坐标 = (22.779978, 114.100912)
   
   误差 = geodesic(真实坐标, 检测坐标).meters
   print(f"定位误差: {误差:.2f}米")
   ```

4. **评估结果**
   - 平均误差应 < 3米
   - 95%结果误差 < 5米

---

## 常见问题

### Q1: 启用增强版后处理速度变慢了？

**A**: 增强版计算量略大（+60%），但不影响实时处理。

如果性能不足：
- 减少跳帧间隔（`frame_skip`）
- 降低YOLO检测分辨率（`imgsz`）

### Q2: 如何判断是否在使用增强版？

**A**: 查看日志输出：

```
✓ 使用增强版坐标转换器（3D姿态修正 + GPS质量控制）
```

或查看CSV中的 `gps_quality` 列：
- 有值 = 增强版
- 空白 = 简化版

### Q3: 所有数据都被过滤了怎么办？

**A**: GPS质量太差或阈值设置太高。

解决方法：
1. 降低要求：
   ```yaml
   min_gps_level: 2
   min_satellite_count: 8
   ```

2. 或关闭过滤：
   ```yaml
   skip_on_low_quality: false
   ```

### Q4: 精度提升不明显？

**A**: 可能原因：

1. **姿态接近垂直**
   - 简化版已足够准确
   - 增强版优势主要在倾斜时

2. **GPS质量差**
   - 增强版无法改善GPS本身的误差
   - 考虑使用RTK设备

3. **相机参数不准确**
   - 检查焦距、分辨率等参数
   - 参考: `M3TD_M4TD相机参数获取指南.md`

### Q5: 如何回退到简化版？

**A**: 修改配置：

```yaml
coordinate_transform:
  use_enhanced: false
```

重新运行即可。CSV格式完全兼容。

---

## 性能对比

| 指标 | 简化版 | 增强版 |
|------|-------|--------|
| **垂直拍摄精度** | 3-5米 | 2-3米 |
| **倾斜拍摄精度** | 8-10米 | 2-3米 ✨ |
| **处理速度** | 基准 | +60%时间 |
| **支持RTK** | 否 | 是 ✨ |
| **质量控制** | 否 | 是 ✨ |
| **误差估算** | 否 | 是 ✨ |

---

## 技术支持

- **详细方案**: `增强版坐标转换实现方案.md`
- **代码文档**: `src/transform/coord_transform_new.py`
- **单元测试**: `tests/test_coord_transform_new.py`

如有问题，请查阅详细方案文档或联系开发团队。
