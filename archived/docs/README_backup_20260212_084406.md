# 无人机水利四乱巡检系统

基于YOLOv11x深度学习模型的无人机视频流实时检测系统，支持离线视频处理和实时流处理两种模式，能够将检测目标的像素坐标转换为WGS84地理坐标。

## 功能特性

### 核心功能
- ✅ **离线视频处理**: 处理本地DJI视频文件+SRT字幕，快速验证算法
- ✅ **实时流处理**: 接收RTSP视频流+MQTT位姿数据，实时检测和输出
- ✅ **YOLOv11x检测**: 高精度目标检测，支持多类别识别
- ✅ **坐标转换**: 像素坐标→WGS84地理坐标（正射投影算法）
- ✅ **CSV报告输出**: 结构化数据导出，包含四角点地理坐标
- ✅ **检测截图保存**: 自动保存检测目标图像
- ✅ **实时可视化**: 显示检测框、GPS信息、处理速度等

### 技术特点
- 模块化架构设计，离线/实时模式共享核心处理逻辑
- 支持DJI无人机SRT字幕自动提取和解析
- 时间戳同步机制，精确匹配视频帧与位姿数据
- 正射投影坐标转换，适用于垂直拍摄场景
- 完善的日志系统和统计信息

## 系统架构

```
数据输入层 (离线/实时)
    ↓
数据同步模块
    ↓
YOLO检测引擎 (YOLOv11x)
    ↓
坐标转换模块 (像素→WGS84)
    ↓
报告输出层 (CSV + 截图)
```

## 项目结构

```
drone_inspection/
├── config/                      # 配置文件
│   ├── camera_params.yaml       # 相机参数
│   ├── yolo_config.yaml         # YOLO配置
│   ├── offline_config.yaml      # 离线模式配置
│   └── realtime_config.yaml     # 实时模式配置
├── src/                         # 源代码
│   ├── input/                   # 数据输入层
│   │   ├── video_file_reader.py
│   │   ├── srt_extractor.py
│   │   ├── srt_parser.py
│   │   ├── rtsp_stream_reader.py
│   │   └── mqtt_client.py
│   ├── detection/               # 检测层
│   │   └── yolo_detector.py
│   ├── transform/               # 坐标转换层
│   │   ├── camera_model.py
│   │   └── coord_transform.py
│   ├── output/                  # 输出层
│   │   ├── csv_writer.py
│   │   ├── image_saver.py
│   │   └── report_generator.py
│   ├── utils/                   # 工具模块
│   │   ├── data_sync.py
│   │   ├── visualizer.py
│   │   ├── logger.py
│   │   └── config_loader.py
│   ├── offline_pipeline.py      # 离线处理流程
│   ├── realtime_pipeline.py     # 实时处理流程
│   └── main.py                  # 主程序入口
├── models/                      # 模型文件
│   └── yolov11x.pt              # YOLO模型权重
├── data/                        # 数据目录
│   ├── input/videos/            # 输入视频
│   ├── temp/srt/                # 临时SRT文件
│   └── output/                  # 输出结果
│       ├── csv/                 # CSV报告
│       └── images/              # 检测截图
├── requirements.txt             # Python依赖
├── README.md                    # 项目文档
├── run_offline.py               # 离线模式快捷启动
└── run_realtime.py              # 实时模式快捷启动
```

## 安装说明

### 1. 系统要求

- Python 3.8+
- CUDA 11.0+ (如使用GPU加速)
- FFmpeg (用于SRT字幕提取)

### 2. 安装依赖

```bash
# 克隆项目
cd drone_inspection

# 安装Python依赖
pip install -r requirements.txt

# 安装FFmpeg (Windows)
# 下载并安装: https://ffmpeg.org/download.html
# 确保ffmpeg在系统PATH中
```

### 3. 准备模型文件

将训练好的YOLOv11x模型权重文件放入 `models/` 目录：

```bash
models/
└── yolov11x.pt
```

### 4. 配置相机参数

编辑 `config/camera_params.yaml`，根据实际DJI 4TD相机参数调整：

```yaml
camera:
  resolution:
    width: 5472    # 根据实际相机调整
    height: 3648
  sensor_size:
    width: 13.2    # 传感器尺寸(mm)
    height: 8.8
  focal_length: 8.8  # 焦距(mm)
```

## 使用方法

### 离线模式 (视频文件处理)

#### 方法1: 使用快捷脚本

```bash
python run_offline.py ./data/input/videos/DJI_0001.MP4
```

#### 方法2: 使用main.py

```bash
python -m src.main --mode offline --video ./data/input/videos/DJI_0001.MP4
```

#### 工作流程

1. 自动从视频中提取SRT字幕（或查找同名SRT文件）
2. 解析SRT获取GPS、高度、姿态数据
3. 逐帧读取视频，同步位姿数据
4. YOLO检测目标
5. 转换像素坐标为地理坐标
6. 输出CSV报告和截图

### 实时模式 (RTSP流 + MQTT)

#### 配置实时参数

编辑 `config/realtime_config.yaml`：

```yaml
rtsp:
  url: "rtsp://192.168.1.100:8554/live"  # RTSP流地址

mqtt:
  broker: "mqtt.dji.com"          # MQTT服务器
  port: 1883
  username: "your_username"
  password: "your_password"
  topics:
    aircraft_state: "thing/product/{gateway_sn}/state"
```

#### 启动实时处理

```bash
# 方法1: 快捷脚本
python run_realtime.py

# 方法2: main.py
python -m src.main --mode realtime
```

## 输出结果

### CSV报告格式

输出文件: `data/output/csv/detections_*.csv`

| 字段 | 说明 |
|------|------|
| timestamp | 时间戳(毫秒) |
| frame_number | 帧号 |
| datetime | 日期时间 |
| class_id | 目标类别ID |
| class_name | 目标类别名称 |
| confidence | 置信度 |
| corner1_lat/lon ~ corner4_lat/lon | 四角点WGS84坐标 |
| center_lat/lon | 中心点坐标 |
| altitude | 飞行高度(米) |
| drone_lat/lon | 无人机GPS坐标 |
| image_path | 截图路径 |

### 检测截图

输出目录: `data/output/images/`

文件命名格式: `frame_000001_obj_001_违建_20240115_103015_123.jpg`

## 配置说明

### 相机参数配置

`config/camera_params.yaml` - 影响坐标转换精度

关键参数:
- `resolution`: 图像分辨率
- `sensor_size`: 传感器物理尺寸
- `focal_length`: 焦距
- `assume_vertical`: 是否假设严格垂直拍摄

### YOLO配置

`config/yolo_config.yaml` - 影响检测性能

关键参数:
- `confidence_threshold`: 置信度阈值 (0.5推荐)
- `device`: cuda或cpu
- `class_names`: 类别名称映射

### 离线模式配置

`config/offline_config.yaml`

关键参数:
- `input.video_path`: 默认视频路径
- `frame_skip`: 跳帧处理 (1=处理每帧)
- `output.save_images`: 是否保存截图
- `visualization.realtime_display`: 是否实时显示

### 实时模式配置

`config/realtime_config.yaml`

关键参数:
- `rtsp.url`: RTSP流地址
- `mqtt.broker`: MQTT服务器地址
- `data_sync.max_time_diff`: 最大时间差容差(毫秒)

## 坐标转换原理

### 正射投影算法 (简化版)

适用于无人机垂直向下拍摄的场景：

```
1. 计算地面分辨率(GSD)
   GSD = (传感器宽度 × 飞行高度) / (焦距 × 图像宽度)

2. 像素偏移 → 地面距离
   dx = (像素x - 图像中心x) × GSD
   dy = (像素y - 图像中心y) × GSD

3. 地面距离 → 经纬度
   目标纬度 = 无人机纬度 + dy / 110540
   目标经度 = 无人机经度 + dx / (111320 × cos(纬度))
```

## 常见问题

### Q: FFmpeg找不到？
A: 确保FFmpeg已安装并添加到系统PATH。测试命令: `ffmpeg -version`

### Q: YOLO模型加载失败？
A: 检查模型文件路径是否正确，确保是YOLOv11格式的权重文件。

### Q: 坐标转换精度不高？
A: 
1. 确认相机参数配置准确（焦距、传感器尺寸）
2. 检查飞行高度数据是否准确
3. 确保无人机接近垂直拍摄

### Q: 实时模式连接不上MQTT？
A: 
1. 检查网络连接
2. 确认MQTT服务器地址和端口
3. 验证用户名密码是否正确

## 开发说明

### 添加自定义类别

编辑 `config/yolo_config.yaml`:

```yaml
classes:
  names:
    0: "违建"
    1: "垃圾堆放"
    2: "乱占"
    3: "乱采"
    4: "您的新类别"  # 添加新类别
```

### 扩展功能

系统采用模块化设计，可轻松扩展：

- 添加新的数据源: 继承 `BaseReader`
- 更换检测模型: 修改 `YOLODetector`
- 自定义输出格式: 扩展 `ReportGenerator`

## 许可证

本项目仅供学习和研究使用。

## 联系方式

如有问题或建议，请提交Issue。

---

**开发团队**: Drone Inspection Team  
**版本**: v1.0.0  
**最后更新**: 2024-02
